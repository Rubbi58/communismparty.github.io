<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Communism Party – Hóriver’s Lair</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #080104;
      color: #f7e3c8;
      overflow: hidden;
    }

    button {
      cursor: pointer;
    }

    .screen {
      position: fixed;
      inset: 0;
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* WELCOME POPUP */

    #welcomeOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #5c0000 0, #050104 60%);
      z-index: 30;
    }

    .welcome-card {
      border-radius: 1.5rem;
      border: 2px solid #ffcc66;
      background:
        linear-gradient(135deg, rgba(255,204,102,0.1), rgba(0,0,0,0.95)),
        repeating-linear-gradient(-45deg, #5a0202 0, #5a0202 4px, #3b0101 4px, #3b0101 8px);
      padding: 2rem 2.5rem;
      max-width: 480px;
      text-align: center;
      box-shadow: 0 24px 60px rgba(0,0,0,0.75);
    }

    .welcome-card h1 {
      font-size: 1.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 0.8rem;
      color: #ffdd88;
    }

    .welcome-card p {
      font-size: 0.95rem;
      color: #ffe8c2;
      margin-bottom: 1.4rem;
    }

    .welcome-card img {
      max-width: 220px;
      display: block;
      margin: 0 auto 1rem;
      image-rendering: pixelated;
    }

    .btn-primary {
      border-radius: 999px;
      padding: 0.7rem 1.6rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: none;
      background: linear-gradient(135deg, #ffcc66, #ff4848);
      color: #3b0000;
      font-weight: 800;
      box-shadow: 0 14px 28px rgba(0,0,0,0.7);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    /* MAP SCREEN */

    #mapScreen {
      background: radial-gradient(circle at top, #5c0000 0, #050104 60%);
      display: flex;
      flex-direction: column;
    }

    .map-header {
      padding: 0.9rem 1.4rem;
      border-bottom: 1px solid rgba(255,204,102,0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #ffdd88;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
    }

    .map-header span {
      opacity: 0.9;
    }

    .map-main {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      display: block;
      image-rendering: pixelated;
      background: #243112;
    }

    .lair-button {
      position: absolute;
      left: 4%;
      top: 7%;
      transform: translateY(0);
      padding: 0.4rem 0.8rem;
      border-radius: 0.7rem;
      border: 1px solid #ffcc66;
      background: rgba(5,0,0,0.85);
      color: #ffdd88;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.7);
    }

    .lair-button img {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
    }

    .lair-button:hover {
      box-shadow: 0 0 16px rgba(255,100,100,0.9);
      border-color: #ff9966;
    }

    .map-footer {
      padding: 0.6rem 1.4rem;
      font-size: 0.75rem;
      color: #f7e3c8;
      border-top: 1px solid rgba(255,204,102,0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .map-footer span {
      opacity: 0.85;
    }

    /* GAME SCREEN */

    #gameScreen {
      background: #050104;
      display: flex;
      flex-direction: column;
    }

    .hud {
      padding: 0.6rem 1.2rem;
      border-bottom: 1px solid rgba(255,204,102,0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
    }

    .mission {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #ffdd88;
    }

    .hud-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.78rem;
      color: #ffe6bf;
    }

    .sprint-bar {
      width: 120px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid #ffcc66;
      overflow: hidden;
      background: rgba(0,0,0,0.7);
    }

    .sprint-bar-inner {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #ffcc66, #ff4444);
      transform-origin: left center;
    }

    #gameCanvas {
      flex: 1;
      display: block;
      width: 100%;
      height: calc(100% - 60px);
      image-rendering: pixelated;
      background: #000;
    }

    /* OVERLAYS */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.87);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .overlay.active {
      display: flex;
    }

    .overlay-card {
      border-radius: 1.2rem;
      border: 2px solid #ffcc66;
      background: radial-gradient(circle at top, #4a0000 0, #050104 60%);
      padding: 1.4rem 1.8rem 1.8rem;
      max-width: 460px;
      text-align: center;
      color: #ffe6bf;
      box-shadow: 0 26px 70px rgba(0,0,0,0.9);
    }

    .overlay-card img {
      max-width: 260px;
      image-rendering: pixelated;
      border-radius: 0.7rem;
      margin-bottom: 0.8rem;
    }

    .overlay-title {
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #ff5555;
      margin-bottom: 0.4rem;
    }

    .overlay-sub {
      font-size: 0.9rem;
      margin-bottom: 1.1rem;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid #ffcc66;
      background: transparent;
      color: #ffdd88;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-size: 0.8rem;
      padding: 0.6rem 1.4rem;
    }

    .btn-secondary:hover {
      background: rgba(255,204,102,0.09);
    }

    /* Horiver hears you banner */

    #alertBanner {
      position: fixed;
      left: 50%;
      top: 8%;
      transform: translateX(-50%);
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid #ff4444;
      background: rgba(60,0,0,0.92);
      color: #ffdddd;
      font-size: 0.82rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      text-align: center;
      display: none;
      z-index: 35;
      box-shadow: 0 10px 24px rgba(0,0,0,0.8);
    }

    @media (max-width: 720px) {
      .welcome-card {
        margin: 0 1rem;
        padding-inline: 1.5rem;
      }

      .lair-button {
        left: 50%;
        top: 8%;
        transform: translateX(-50%);
      }

      .hud {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.4rem;
      }

      #gameCanvas {
        height: calc(100% - 72px);
      }
    }
  </style>
</head>
<body>

<!-- WELCOME POPUP -->
<div id="welcomeOverlay">
  <div class="welcome-card">
    <!-- You can swap this image to any “welcome” graphic you make -->
    <img src="images/horiver lair.png" alt="Communism Party">
    <h1>WELCOME TO COMMUNISM PARTY</h1>
    <p>
      A cursed retro HQ. Explore the map, enter Hóriver’s Lair, and find a way
      to destroy Oliver’s vape before he catches you in the mist.
    </p>
    <button class="btn-primary" id="welcomeEnterBtn">Enter Headquarters</button>
  </div>
</div>

<!-- MAP SCREEN -->
<div id="mapScreen" class="screen active">
  <div class="map-header">
    <span>COMMUNIST OVERWORLD – LEVEL SELECT</span>
    <span>Use mouse – click a fortress</span>
  </div>
  <div class="map-main">
    <!-- Fullscreen level map background: if you ever add a real map image, draw it in JS or set as background -->
    <canvas id="mapCanvas"></canvas>

    <!-- Clickable Level 1 icon (top-left) -->
    <div class="lair-button" id="lairButton" title="Enter Hóriver's Lair">
      <img src="images/horiver lair.png" alt="Hóriver's Lair">
      <div>
        <div style="font-weight:800; font-size:0.8rem;">LEVEL 1</div>
        <div style="font-size:0.75rem;">HÓRIVER'S LAIR</div>
      </div>
    </div>
  </div>
  <div class="map-footer">
    <span>Only Level 1 is available for now.</span>
    <span>More cursed provinces will unlock later.</span>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <div class="hud">
    <div class="mission" id="missionText">MISSION: FIND AND DESTROY OLIVER'S VAPE</div>
    <div class="hud-right">
      <div>Controls: WASD to move, Shift to sprint, closets = safe</div>
      <div class="sprint-bar">
        <div class="sprint-bar-inner" id="sprintBarInner"></div>
      </div>
    </div>
  </div>
  <canvas id="gameCanvas" width="960" height="540"></canvas>
</div>

<div id="alertBanner">HÓRIVER HEARS YOU</div>

<!-- DEATH OVERLAY -->
<div id="deathOverlay" class="overlay">
  <div class="overlay-card">
    <img src="images/horiver jumpscare.png" alt="Jumpscare">
    <div class="overlay-title">WASTED</div>
    <div class="overlay-sub">Hóriver caught you in the fog. The vape remains undefeated.</div>
    <button class="btn-primary" id="retryLevelBtn" style="margin-right:0.75rem;">Retry Level</button>
    <button class="btn-secondary" id="backToMapBtn">Back to Map</button>
  </div>
</div>

<!-- WIN OVERLAY -->
<div id="winOverlay" class="overlay">
  <div class="overlay-card">
    <img src="images/bhoriver token.png" alt="Token reward">
    <div class="overlay-title" style="color:#ffdd88;">MISSION COMPLETE</div>
    <div class="overlay-sub">
      The cursed vape is flushed. Hóriver fades in anguish and you claim your token.
    </div>
    <button class="btn-primary" id="winBackToMapBtn">Return to Overworld</button>
  </div>
</div>

<script>
  // -----------------------------
  // ASSET LOADING – AUDIO
  // -----------------------------
  const sounds = {
    menuClick: new Audio("sounds/menu click.mp3"),
    start: new Audio("sounds/start sound.mp3"),
    bgm: new Audio("sounds/backg music.mp3"),
    pickup: new Audio("sounds/item pickup.mp3"),
    door: new Audio("sounds/door open.mp3"),
    jumpscare: new Audio("sounds/jumpscare.mp3"),
    flush: new Audio("sounds/toilet flush.mp3"),
    win: new Audio("sounds/win.mp3")
  };
  sounds.bgm.loop = true;
  sounds.bgm.volume = 0.3;

  function safePlay(audio) {
    if (!audio) return;
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }

  // -----------------------------
  // SCREEN MANAGEMENT
  // -----------------------------

  const welcomeOverlay = document.getElementById("welcomeOverlay");
  const mapScreen = document.getElementById("mapScreen");
  const gameScreen = document.getElementById("gameScreen");
  const deathOverlay = document.getElementById("deathOverlay");
  const winOverlay = document.getElementById("winOverlay");
  const alertBanner = document.getElementById("alertBanner");

  function showScreen(screenName) {
    mapScreen.classList.remove("active");
    gameScreen.classList.remove("active");
    if (screenName === "map") {
      mapScreen.classList.add("active");
    } else if (screenName === "game") {
      gameScreen.classList.add("active");
    }
  }

  // -----------------------------
  // MAP SCREEN – SIMPLE BACKGROUND + LAIR ICON
  // -----------------------------
  const mapCanvas = document.getElementById("mapCanvas");
  const mapCtx = mapCanvas.getContext("2d");

  function resizeMapCanvas() {
    mapCanvas.width = mapCanvas.clientWidth;
    mapCanvas.height = mapCanvas.clientHeight;
    drawMapBackground();
  }

  window.addEventListener("resize", resizeMapCanvas);

  function drawMapBackground() {
    const w = mapCanvas.width;
    const h = mapCanvas.height;

    // Simple stylized overworld background
    const grd = mapCtx.createLinearGradient(0, 0, 0, h);
    grd.addColorStop(0, "#4a1b0f");
    grd.addColorStop(0.35, "#3b4f1f");
    grd.addColorStop(1, "#1c2510");
    mapCtx.fillStyle = grd;
    mapCtx.fillRect(0, 0, w, h);

    // fake paths
    mapCtx.strokeStyle = "#d99b4a";
    mapCtx.lineWidth = 14;
    mapCtx.lineCap = "round";
    mapCtx.beginPath();
    mapCtx.moveTo(w * 0.1, h * 0.25);
    mapCtx.lineTo(w * 0.3, h * 0.4);
    mapCtx.lineTo(w * 0.5, h * 0.42);
    mapCtx.lineTo(w * 0.7, h * 0.6);
    mapCtx.stroke();

    // mountains right side
    mapCtx.fillStyle = "#555970";
    for (let i = 0; i < 10; i++) {
      const x = w * 0.45 + i * (w * 0.05);
      const y = h * 0.2 + Math.sin(i) * 10;
      mapCtx.beginPath();
      mapCtx.moveTo(x, y);
      mapCtx.lineTo(x + 40, y + 80);
      mapCtx.lineTo(x - 40, y + 80);
      mapCtx.closePath();
      mapCtx.fill();
    }

    // lakes
    mapCtx.fillStyle = "#3b74c0";
    mapCtx.beginPath();
    mapCtx.ellipse(w * 0.35, h * 0.6, w * 0.1, h * 0.07, 0, 0, Math.PI * 2);
    mapCtx.fill();
    mapCtx.beginPath();
    mapCtx.ellipse(w * 0.65, h * 0.35, w * 0.08, h * 0.05, 0, 0, Math.PI * 2);
    mapCtx.fill();

    // forest left
    mapCtx.fillStyle = "#27421a";
    for (let i = 0; i < 40; i++) {
      const x = Math.random() * w * 0.45;
      const y = h * 0.4 + Math.random() * h * 0.55;
      mapCtx.beginPath();
      mapCtx.moveTo(x, y);
      mapCtx.lineTo(x + 10, y + 26);
      mapCtx.lineTo(x - 10, y + 26);
      mapCtx.closePath();
      mapCtx.fill();
    }

    // fortress top-left (Hóriver's Lair illustration)
    mapCtx.fillStyle = "#b23b2f";
    const fx = w * 0.08;
    const fy = h * 0.12;
    mapCtx.fillRect(fx, fy, 90, 50);
    mapCtx.fillStyle = "#79301f";
    mapCtx.fillRect(fx + 8, fy + 28, 24, 22);
    mapCtx.fillRect(fx + 52, fy + 28, 24, 22);
    mapCtx.fillStyle = "#d4af6a";
    mapCtx.fillRect(fx + 34, fy + 20, 22, 30);
  }

  resizeMapCanvas();

  // -----------------------------
  // GAME / LEVEL 1 IMPLEMENTATION
  // -----------------------------

  const gameCanvas = document.getElementById("gameCanvas");
  const ctx = gameCanvas.getContext("2d");
  gameCanvas.width = 960;
  gameCanvas.height = 540;

  const TILE = 16;
  const SCALE = 3;
  const DRAW_TILE = TILE * SCALE;

  const tilesheet = new Image();
  tilesheet.src = "images/dungeons pack.png";

  const playerSprite = new Image();
  playerSprite.src = "images/player.png";

  const horiverSprite = new Image();
  horiverSprite.src = "images/horiver character.png";

  const flashlightSprite = new Image();
  flashlightSprite.src = "images/pixel-flashlight.png";

  const keySprite = new Image();
  keySprite.src = "images/key pixel.png";

  const vapeSprite = new Image();
  vapeSprite.src = "images/vape pixel.png";

  const tokenSprite = new Image();
  tokenSprite.src = "images/bhoriver token.png";

  // Simple tile indices (guessed positions on tilesheet)
  const tileIndex = {
    floor: {x: 5, y: 5},
    wall: {x: 0, y: 0},
    door: {x: 7, y: 4},
    closet: {x: 9, y: 6},
    bathroomFloor: {x: 4, y: 8},
    throne: {x: 10, y: 4},
    chest: {x: 8, y: 6},
    toilet: {x: 1, y: 9}
  };

  function drawTile(type, gx, gy) {
    const info = tileIndex[type] || tileIndex.floor;
    ctx.drawImage(
      tilesheet,
      info.x * TILE, info.y * TILE, TILE, TILE,
      gx * DRAW_TILE, gy * DRAW_TILE, DRAW_TILE, DRAW_TILE
    );
  }

  // Map layout (simple handcrafted grid)
  // 0 = wall, 1 = floor, 2 = door, 3 = throne, 4 = closet, 5 = bathroom, 6 = chest
  const mapWidth = 30;
  const mapHeight = 17;

  const mapGrid = [
    "000000000000000000000000000000",
    "011111111111111111111111111110",
    "010000001000000010000001000010",
    "012000001000000010000001000010",
    "011111111111311111111111111110",
    "010000001000000010000001000010",
    "011100001011110010111001011110",
    "010100401000010010000001000010",
    "010111111000010011111111000010",
    "010000001000010010000001000010",
    "011111111111111111111111111110",
    "010600001000000010000001000010",
    "010000001000000010000001000010",
    "011111111111111111111111111110",
    "010000001000050010000001000010",
    "011111111111111111111111111110",
    "000000000000000000000000000000"
  ];

  function isWalkableCell(x, y) {
    if (x < 0 || y < 0 || x >= mapWidth || y >= mapHeight) return false;
    const c = mapGrid[y][x];
    return c === "1" || c === "2" || c === "3" || c === "4" || c === "5" || c === "6";
  }

  const keyRoom = {x1: 1, y1: 11, x2: 6, y2: 13};     // approximate room with chest & key
  const bathroomArea = {x1: 13, y1: 14, x2: 19, y2: 15};
  const thronePos = {x: 15, y: 4};
  const chestPos = {x: 2, y: 11};
  const flashlightPos = {x: thronePos.x, y: thronePos.y};
  const keyPos = {x: 3, y: 11};
  const bathroomToiletPos = {x: 16, y: 14};

  let player = {
    x: 4.5,
    y: 9.5,
    speed: 2.0,
    sprintSpeed: 3.6,
    width: 0.7,
    height: 0.7
  };

  let horiver = {
    x: thronePos.x + 0.5,
    y: thronePos.y + 1.3,
    speed: 2.0,
    active: false,
    fading: false
  };

  let haveFlashlight = false;
  let haveKey = false;
  let haveVape = false;
  let vapeDestroyed = false;
  let keyRoomTriggered = false;
  let inKeyRoom = false;
  let sprintValue = 1.0; // 0..1
  let sprinting = false;
  let gameRunning = false;
  let lastTime = 0;
  let deathPending = false;
  let winPending = false;

  const keys = {
    w: false,
    a: false,
    s: false,
    d: false,
    shift: false
  };

  window.addEventListener("keydown", (e) => {
    if (e.key === "w" || e.key === "W") keys.w = true;
    if (e.key === "a" || e.key === "A") keys.a = true;
    if (e.key === "s" || e.key === "S") keys.s = true;
    if (e.key === "d" || e.key === "D") keys.d = true;
    if (e.key === "Shift") keys.shift = true;
  });

  window.addEventListener("keyup", (e) => {
    if (e.key === "w" || e.key === "W") keys.w = false;
    if (e.key === "a" || e.key === "A") keys.a = false;
    if (e.key === "s" || e.key === "S") keys.s = false;
    if (e.key === "d" || e.key === "D") keys.d = false;
    if (e.key === "Shift") keys.shift = false;
  });

  const sprintBarInner = document.getElementById("sprintBarInner");
  const missionText = document.getElementById("missionText");

  function resetLevel() {
    player.x = 4.5;
    player.y = 9.5;
    haveFlashlight = false;
    haveKey = false;
    haveVape = false;
    vapeDestroyed = false;
    keyRoomTriggered = false;
    inKeyRoom = false;
    sprintValue = 1.0;
    horiver.x = thronePos.x + 0.5;
    horiver.y = thronePos.y + 1.3;
    horiver.active = false;
    horiver.fading = false;
    deathPending = false;
    winPending = false;
    missionText.textContent = "MISSION: FIND AND DESTROY OLIVER'S VAPE";
    hideAlert();
  }

  function startLevel() {
    resetLevel();
    gameRunning = true;
    lastTime = performance.now();
    showScreen("game");
    safePlay(sounds.start);
    safePlay(sounds.bgm);
    requestAnimationFrame(gameLoop);
  }

  function backToMap() {
    gameRunning = false;
    showScreen("map");
  }

  function showAlert() {
    alertBanner.style.display = "block";
    setTimeout(() => {
      alertBanner.style.display = "none";
    }, 2200);
  }

  function hideAlert() {
    alertBanner.style.display = "none";
  }

  function update(delta) {
    if (!gameRunning) return;

    // Movement
    let dx = 0;
    let dy = 0;
    if (keys.w) dy -= 1;
    if (keys.s) dy += 1;
    if (keys.a) dx -= 1;
    if (keys.d) dx += 1;

    let len = Math.hypot(dx, dy);
    if (len > 0) {
      dx /= len;
      dy /= len;
    }

    sprinting = keys.shift && sprintValue > 0.05 && (dx !== 0 || dy !== 0);

    let speed = player.speed;
    if (sprinting) {
      speed = player.sprintSpeed;
      sprintValue -= delta / 3; // drains in ~3s
    } else {
      sprintValue += delta / 6; // recharge slower
    }
    sprintValue = Math.max(0, Math.min(1, sprintValue));
    sprintBarInner.style.transform = `scaleX(${sprintValue})`;

    const move = speed * delta;

    function tryMove(axis) {
      let newX = player.x;
      let newY = player.y;
      if (axis === "x") newX += dx * move;
      if (axis === "y") newY += dy * move;

      const halfW = player.width / 2;
      const halfH = player.height / 2;
      const corners = [
        {x: newX - halfW, y: newY - halfH},
        {x: newX + halfW, y: newY - halfH},
        {x: newX - halfW, y: newY + halfH},
        {x: newX + halfW, y: newY + halfH}
      ];
      for (const c of corners) {
        const gx = Math.floor(c.x);
        const gy = Math.floor(c.y);
        if (!isWalkableCell(gx, gy)) {
          return;
        }
      }
      player.x = newX;
      player.y = newY;
    }

    tryMove("x");
    tryMove("y");

    // Key room enter/leave detection
    const px = player.x;
    const py = player.y;
    const nowInKeyRoom =
      px >= keyRoom.x1 && px <= keyRoom.x2 &&
      py >= keyRoom.y1 && py <= keyRoom.y2;

    if (!inKeyRoom && nowInKeyRoom) {
      inKeyRoom = true;
    }
    if (inKeyRoom && !nowInKeyRoom) {
      inKeyRoom = false;
      if (haveKey && !keyRoomTriggered) {
        keyRoomTriggered = true;
        horiver.active = true;
        safePlay(sounds.jumpscare);
        showAlert();
      }
    }

    // Item pickups
    function distTo(pos) {
      const dx = player.x - (pos.x + 0.5);
      const dy = player.y - (pos.y + 0.5);
      return Math.hypot(dx, dy);
    }

    // Flashlight
    if (!haveFlashlight && distTo(flashlightPos) < 0.8) {
      haveFlashlight = true;
      safePlay(sounds.pickup);
      missionText.textContent = "MISSION: FIND THE KEY TO HÓRIVER'S CHEST";
    }

    // Key
    if (!haveKey && distTo(keyPos) < 0.8) {
      haveKey = true;
      safePlay(sounds.pickup);
      missionText.textContent = "MISSION: FIND THE CHEST CONTAINING THE VAPE";
    }

    // Chest -> vape
    if (!haveVape && haveKey && distTo(chestPos) < 0.9) {
      haveVape = true;
      safePlay(sounds.pickup);
      missionText.textContent = "MISSION: FIND THE BATHROOM AND DESTROY THE VAPE";
    }

    // Bathroom flush
    if (!vapeDestroyed && haveVape && distTo(bathroomToiletPos) < 0.9) {
      vapeDestroyed = true;
      haveVape = false;
      safePlay(sounds.flush);
      missionText.textContent = "MISSION: RETURN TO THE THRONE TO CLAIM YOUR TOKEN";
      horiver.fading = true;
    }

    // Hóriver AI
    if (horiver.active && !horiver.fading) {
      const hx = horiver.x;
      const hy = horiver.y;
      const dxh = player.x - hx;
      const dyh = player.y - hy;
      const dlen = Math.hypot(dxh, dyh);
      if (dlen > 0.01) {
        const ndx = dxh / dlen;
        const ndy = dyh / dlen;
        const step = horiver.speed * delta;

        let newX = hx + ndx * step;
        let newY = hy + ndy * step;

        // collisions
        const gx = Math.floor(newX);
        const gy = Math.floor(newY);
        if (isWalkableCell(gx, gy)) {
          horiver.x = newX;
          horiver.y = newY;
        }
      }
    } else if (horiver.fading) {
      horiver.active = false;
    }

    // Death check (closets = safe)
    const playerCell = {
      x: Math.floor(player.x),
      y: Math.floor(player.y)
    };
    const cellChar = mapGrid[playerCell.y][playerCell.x];
    const hiding = cellChar === "4"; // closet

    const distPH = Math.hypot(player.x - horiver.x, player.y - horiver.y);
    if (!hiding && horiver.active && distPH < 0.7 && !deathPending && !winPending) {
      deathPending = true;
      gameRunning = false;
      safePlay(sounds.jumpscare);
      setTimeout(() => {
        deathOverlay.classList.add("active");
      }, 100);
    }

    // Win condition: return to throne after destroying vape
    if (vapeDestroyed && distTo(thronePos) < 0.9 && !winPending) {
      winPending = true;
      gameRunning = false;
      safePlay(sounds.win);
      setTimeout(() => {
        winOverlay.classList.add("active");
      }, 200);
    }
  }

  function draw() {
    ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

    const cols = Math.floor(gameCanvas.width / DRAW_TILE);
    const rows = Math.floor(gameCanvas.height / DRAW_TILE);

    // Center camera on player
    const camX = player.x * DRAW_TILE - gameCanvas.width / 2;
    const camY = player.y * DRAW_TILE - gameCanvas.height / 2;

    // Draw map
    for (let y = 0; y < mapHeight; y++) {
      for (let x = 0; x < mapWidth; x++) {
        const c = mapGrid[y][x];
        const gx = x;
        const gy = y;
        const screenX = gx * DRAW_TILE - camX;
        const screenY = gy * DRAW_TILE - camY;

        if (screenX < -DRAW_TILE || screenY < -DRAW_TILE ||
            screenX > gameCanvas.width || screenY > gameCanvas.height) continue;

        if (c === "0") {
          drawTile("wall", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        } else {
          drawTile("floor", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        }

        if (c === "2") {
          drawTile("door", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        } else if (c === "3") {
          drawTile("throne", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        } else if (c === "4") {
          drawTile("closet", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        } else if (c === "5") {
          drawTile("bathroomFloor", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        } else if (c === "6") {
          drawTile("chest", (gx * DRAW_TILE - camX)/DRAW_TILE, (gy * DRAW_TILE - camY)/DRAW_TILE);
        }
      }
    }

    // Items
    function drawSprite(sprite, pos, sizeMul=1) {
      const sx = pos.x * DRAW_TILE - camX;
      const sy = pos.y * DRAW_TILE - camY;
      const w = DRAW_TILE * sizeMul;
      const h = DRAW_TILE * sizeMul;
      ctx.drawImage(sprite, sx, sy, w, h);
    }

    if (!haveFlashlight) {
      drawSprite(flashlightSprite, flashlightPos);
    }

    if (!haveKey) {
      drawSprite(keySprite, keyPos);
    }

    if (!haveVape && !vapeDestroyed && haveKey) {
      drawSprite(vapeSprite, chestPos);
    }

    // Bathroom toilet icon
    drawTile("toilet", (bathroomToiletPos.x * DRAW_TILE - camX)/DRAW_TILE,
                         (bathroomToiletPos.y * DRAW_TILE - camY)/DRAW_TILE);

    // Player
    drawSprite(playerSprite, {x: player.x - 0.5, y: player.y - 0.9}, 1.2);

    // Horiver
    if (horiver.active || horiver.fading) {
      drawSprite(horiverSprite, {x: horiver.x - 0.5, y: horiver.y - 0.9}, 1.2);
    }

    // Fog of war (short FOV)
    const fog = ctx.createRadialGradient(
      gameCanvas.width/2, gameCanvas.height/2, 40,
      gameCanvas.width/2, gameCanvas.height/2, 260
    );
    fog.addColorStop(0, "rgba(0,0,0,0)");
    fog.addColorStop(0.55, "rgba(255,255,255,0.02)");
    fog.addColorStop(1, "rgba(255,255,255,0.85)");
    ctx.fillStyle = fog;
    ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
  }

  function gameLoop(timestamp) {
    if (!gameRunning) return;
    const delta = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    update(delta);
    draw();

    requestAnimationFrame(gameLoop);
  }

  // -----------------------------
  // UI EVENTS
  // -----------------------------

  document.getElementById("welcomeEnterBtn").addEventListener("click", () => {
    safePlay(sounds.menuClick);
    welcomeOverlay.style.display = "none";
  });

  document.getElementById("lairButton").addEventListener("click", () => {
    safePlay(sounds.menuClick);
    startLevel();
  });

  document.getElementById("retryLevelBtn").addEventListener("click", () => {
    safePlay(sounds.menuClick);
    deathOverlay.classList.remove("active");
    startLevel();
  });

  document.getElementById("backToMapBtn").addEventListener("click", () => {
    safePlay(sounds.menuClick);
    deathOverlay.classList.remove("active");
    sounds.bgm.pause();
    backToMap();
  });

  document.getElementById("winBackToMapBtn").addEventListener("click", () => {
    safePlay(sounds.menuClick);
    winOverlay.classList.remove("active");
    sounds.bgm.pause();
    backToMap();
  });

</script>
</body>
</html>

